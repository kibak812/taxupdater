# 예규판례 모니터링 시스템 변경 이력

이 문서는 예규판례 모니터링 시스템의 주요 개발 내역과 변경사항을 시간순으로 기록합니다.

## 목차
- [2025년 7월](#2025년-7월)
- [2025년 6월](#2025년-6월)

---

## 2025년 7월

### 2025.07.13 - 국세청 링크 생성 시스템 개선
#### 🎯 핵심 문제 해결
- **링크 생성 성공률**: 0% → 100% (10,155건 완전 복구)
- **복잡한 ntstDcmId 추출 로직** → **간단한 문서번호 기반 검색 링크**

#### 🛠️ 기술적 변경사항
- **신규 모듈**: `src/utils/link_generator.py` 생성
- **크롤러 간소화**: JavaScript 로직 60줄 → 15줄 (75% 감소)
- **링크 형태**: `https://taxlaw.nts.go.kr/is/USEISA001M.do?schVcb={문서번호}&searchType=totalSearch`

#### 📊 처리 결과
- **유권해석**: 5,052건 링크 생성 완료
- **판례**: 5,103건 링크 생성 완료
- **배치 업데이트**: 100건씩 안전한 일괄 처리

#### 🔧 개선 효과
- **유지보수성**: 사이트 구조 변경에 독립적
- **안정성**: URL 인코딩 및 유효성 검증
- **확장성**: 다른 사이트 적용 가능한 구조

### 2025.07.07 - LocalTunnel 기반 완전 자동화 시스템
- **혁신적 변화**: ngrok → LocalTunnel 전환으로 URL 변경 문제 완전 해결
- **고정 URL**: `https://taxupdater-monitor.loca.lt` (영구 고정)
- **완전 자동화**: 재부팅 후 자동으로 동일한 URL로 복구
- **코드 정리**: ngrok 관련 코드 225줄 이상 제거로 간소화
- **사용자 경험**: Zero Configuration, Zero Maintenance 실현

### 2025.07.06 - 프로젝트 구조 정리
- **체계적인 파일 분류**: 루트 디렉토리 파일들을 성격별로 정리
- **새로운 디렉토리 구조**: `docs/`, `scripts/`, `tests/`, `config/`, `deploy/` 생성
- **ngrok 잔재 제거**: 관련 파일 11개 삭제
- **가독성 향상**: 프로젝트 구조가 직관적이고 표준적으로 개선

### 2025.07.05 - 배포 관련 파일 정리 및 Fly.io 문제 해결
#### 배포 파일 정리
- **삭제된 파일**: `render.yaml`, `build.sh`, `railway.json`, `Procfile`, `Dockerfile`, `.dockerignore`
- **배포 전략 명확화**: LocalTunnel(주력) + Fly.io(대안) 조합으로 단순화

#### Fly.io 배포 문제 해결
- **문제**: 모니터링 시스템 테이블 누락으로 API 500 에러
- **해결**: 자동 마이그레이션 시스템 구현 및 안전한 서비스 초기화
- **배포용 도구**: `migration_check.py` 스크립트 제공

### 2025.07.02 - 최종 사용자 경험 최적화

#### 크롤링 진행현황 개선
- **상세 통계 표시**: "287개 수집, 3개 신규, 284개 중복" 형태의 투명한 정보
- **전체 삭제 기능**: 진행현황 일괄 삭제 기능 추가
- **버튼 가시성 개선**: 주요 버튼들을 `btn-primary` 스타일로 변경

#### 스케줄 관리 시스템 강화
- **동적 cron 표현식**: 크롤링 주기 변경 시 즉시 모든 스케줄 업데이트
- **스케줄러 토글 안정화**: 실제 시스템 상태 기반 토글 로직 구현
- **주기 범위**: 1시간 ~ 168시간(7일) 지원

#### 모바일 최적화
- **반응형 레이아웃**: 모바일 화면에 최적화된 수직 스택 구조
- **터치 친화적 UI**: 적절한 패딩과 폰트 크기 조정
- **접기/펼치기 기능**: 화면 공간 효율성을 위한 토글 기능 추가

#### 시스템 명칭 개선
- **변경**: "세금법령 모니터링 시스템" → "예규판례 모니터링 시스템"
- **효과**: 수집 데이터의 성격을 정확히 표현하여 전문성 향상

### 2025.07.01 - 데이터 일관성 개선

#### 스마트 데이터 필터링 시스템
- **상태 카드 클릭**: 시간 필터 기간의 신규 데이터만 표시
- **데이터 보기 버튼**: 전체 데이터 표시
- **URL 파라미터**: `?filter=recent&days=3` 형태로 필터링 지원

#### 데이터 일관성 문제 해결
- **문제**: 대시보드 카드 숫자와 실제 데이터 개수 불일치
- **해결**: 단일 데이터 소스 사용 (`/api/sites/recent-counts`)
- **결과**: 100% 일관된 데이터 표시

#### 마지막 업데이트 시간 표시 개선
- **문제**: 모든 사이트가 동일한 시간 표시
- **해결**: 각 사이트 테이블의 실제 최신 데이터 시간 조회
- **구현**: `get_statistics()` 메서드에서 `MAX(created_at/updated_at)` 사용

#### 타임스탬프 표준화
- **자동 주입**: 모든 데이터 저장 시 `created_at`, `updated_at` 자동 추가
- **형식**: `YYYY-MM-DD HH:MM:SS` 표준 형식 사용

---

## 2025년 6월

### 2025.06.30 - 자동 모니터링 시스템 완성

#### 새로운 기능
- **주기적 자동 크롤링**: APScheduler 기반 백그라운드 스케줄링
- **새로운 데이터 탐지**: 실시간 신규 데이터 발견 및 로깅
- **실시간 알림 시스템**: WebSocket 기반 즉시 알림
- **모니터링 중심 UI**: 새로운 데이터 중심의 대시보드

#### UI 현대화 및 한국어화
- **프리미엄 UI 디자인**: Inter 폰트, 프로페셔널 컬러 스킴, SVG 아이콘
- **완전 한국어화**: 모든 UI 텍스트, 에러 메시지, 기관명 한국어 변환
- **새로운 경로 구조**: `/dashboard`, `/data/{site_key}`, `/settings`, `/legacy`

#### 새로운 데이터베이스 테이블
- `crawl_schedules`: 사이트별 크롤링 스케줄 관리
- `notification_history`: 알림 이력 및 상태 관리
- `new_data_log`: 새로운 데이터 발견 로그
- `system_status`: 시스템 건강도 및 상태 모니터링

### 2025.06.29 - 크롤링 시스템 현황 및 버그 수정

#### 완료된 크롤러
1. **조세심판원**: Selenium 기반 클래스 크롤러
2. **국세법령정보시스템 (유권해석)**: Selenium 기반 클래스 크롤러
3. **국세법령정보시스템 (판례)**: Selenium 기반 클래스 크롤러
4. **기획재정부**: 웹 레거시 크롤러 (tkinter 의존성 제거)
5. **행정안전부**: 웹 레거시 크롤러 (upperMenuId 파라미터 필수)
6. **감사원**: 웹 레거시 크롤러 (드롭다운 선택 + 검색 로직)

#### 주요 버그 수정
- **WebSocketProgress 에러**: `progress['value']` → `progress.value` 수정
- **전체 크롤링 API 경로**: `/api/crawl/all`을 `/api/crawl/{site_key}` 앞에 정의
- **WebSocket 연결 상태**: `window.app` 전역 노출로 정확한 상태 표시

#### SQLite UNIQUE Constraint 해결
- **문제**: PRIMARY KEY 충돌
- **해결**: INSERT OR IGNORE 방식으로 자동 처리
- **구현**: `_insert_with_ignore()` 메서드 추가

### 2025.06.28 - 크롤러별 특이사항

#### 행정안전부 크롤링
- **필수 파라미터**: `upperMenuId` 없으면 로그인 페이지로 리다이렉트
- **올바른 URL**: `?menuNo=9020000&upperMenuId=9000000`
- **데이터 추출**: 세목, 날짜, 문서번호, 링크 파싱 로직 구현

#### 감사원 크롤링
- **청구분야 드롭다운**: 국세(10), 지방세(20) 선택 후 검색
- **크롤링 범위**: 국세 5페이지 + 지방세 5페이지 = 총 100개 항목

---

## 관련 문서
- 기술적 세부사항: [TECHNICAL_DETAILS.md](./TECHNICAL_DETAILS.md)
- 문제 해결 가이드: [TROUBLESHOOTING.md](./TROUBLESHOOTING.md)
- 배포 가이드: [DEPLOYMENT.md](./DEPLOYMENT.md)