// Tax Law Crawler Web Interface - JavaScript
// ÏÑ∏Í∏à Î≤ïÎ†π ÌÅ¨Î°§ÎßÅ ÏãúÏä§ÌÖú Ïõπ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÇ¨Ïù¥Îìú Î°úÏßÅ

class TaxCrawlerApp {
    constructor() {
        this.ws = null;
        this.isConnected = false;
        this.init();
    }

    async init() {
        console.log('Tax Crawler App Ï¥àÍ∏∞Ìôî Ï§ë...');
        
        // WebSocket Ïó∞Í≤∞
        this.connectWebSocket();
        
        // ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        if (document.getElementById('dashboard')) {
            await this.loadDashboardData();
            // 30Ï¥àÎßàÎã§ ÎåÄÏãúÎ≥¥Îìú ÏÉàÎ°úÍ≥†Ïπ®
            setInterval(() => this.loadDashboardData(), 30000);
        }
        
        // ÏÇ¨Ïù¥Ìä∏Î≥Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        if (document.getElementById('siteData')) {
            await this.loadSiteData();
        }
        
        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
        this.setupEventListeners();
        
        console.log('Tax Crawler App Ï¥àÍ∏∞Ìôî ÏôÑÎ£å');
    }

    connectWebSocket() {
        try {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/crawl`;
            
            this.ws = new WebSocket(wsUrl);
            
            this.ws.onopen = () => {
                console.log('WebSocket Ïó∞Í≤∞ ÏÑ±Í≥µ');
                this.isConnected = true;
                this.showNotification('Ïã§ÏãúÍ∞Ñ Î™®ÎãàÌÑ∞ÎßÅ Ïó∞Í≤∞Îê®', 'success');
            };
            
            this.ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                this.handleWebSocketMessage(data);
            };
            
            this.ws.onclose = () => {
                console.log('WebSocket Ïó∞Í≤∞ Ï¢ÖÎ£å');
                this.isConnected = false;
                // 3Ï¥à ÌõÑ Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ
                setTimeout(() => this.connectWebSocket(), 3000);
            };
            
            this.ws.onerror = (error) => {
                console.error('WebSocket Ïò§Î•ò:', error);
                this.showNotification('Ïã§ÏãúÍ∞Ñ Ïó∞Í≤∞ Ïò§Î•ò Î∞úÏÉù', 'error');
            };
            
        } catch (error) {
            console.error('WebSocket Ïó∞Í≤∞ Ïã§Ìå®:', error);
        }
    }

    handleWebSocketMessage(data) {
        console.log('WebSocket Î©îÏãúÏßÄ:', data);
        
        switch (data.type) {
            case 'crawl_start':
                this.showNotification(`ÌÅ¨Î°§ÎßÅ ÏãúÏûë: ${this.getCrawlChoiceName(data.choice)}`, 'info');
                this.updateCrawlStatus('ÏßÑÌñâ Ï§ë...');
                break;
                
            case 'crawl_status':
                this.updateCrawlStatus(data.status);
                break;
                
            case 'crawl_complete':
                this.showNotification(`ÌÅ¨Î°§ÎßÅ ÏôÑÎ£å: ${this.getCrawlChoiceName(data.choice)}`, 'success');
                this.updateCrawlStatus('ÏôÑÎ£å');
                // ÎåÄÏãúÎ≥¥Îìú ÏÉàÎ°úÍ≥†Ïπ®
                setTimeout(() => this.loadDashboardData(), 2000);
                break;
                
            case 'crawl_error':
                this.showNotification(`ÌÅ¨Î°§ÎßÅ Ïò§Î•ò: ${data.error}`, 'error');
                this.updateCrawlStatus('Ïò§Î•ò Î∞úÏÉù');
                break;
        }
    }

    getCrawlChoiceName(choice) {
        const choices = {
            '1': 'Ï°∞ÏÑ∏Ïã¨ÌåêÏõê',
            '2': 'Íµ≠ÏÑ∏Ï≤≠',
            '3': 'Í∏∞ÌöçÏû¨Ï†ïÎ∂Ä',
            '4': 'Íµ≠ÏÑ∏Ï≤≠ ÌåêÎ°Ä',
            '5': 'ÌñâÏ†ïÏïàÏ†ÑÎ∂Ä',
            '6': 'Í∞êÏÇ¨Ïõê',
            '7': 'Ï†ÑÏ≤¥ ÏÇ¨Ïù¥Ìä∏'
        };
        return choices[choice] || 'Ïïå Ïàò ÏóÜÏùå';
    }

    async loadDashboardData() {
        try {
            console.log('ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞ Î°úÎî©...');
            
            const response = await fetch('/api/dashboard');
            if (!response.ok) throw new Error('ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®');
            
            const data = await response.json();
            this.renderDashboard(data);
            
            console.log('ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å:', data);
            
        } catch (error) {
            console.error('ÎåÄÏãúÎ≥¥Îìú Î°úÎìú Ïò§Î•ò:', error);
            this.showNotification('ÎåÄÏãúÎ≥¥Îìú Î°úÎìú Ïã§Ìå®', 'error');
        }
    }

    renderDashboard(data) {
        const dashboard = document.getElementById('dashboard');
        if (!dashboard) return;
        
        dashboard.innerHTML = data.sites.map(site => `
            <div class="site-card" style="--site-color: ${site.color}">
                <div class="site-header">
                    <div class="site-name">${site.site_name}</div>
                    <div class="site-status status-${site.status}">
                        ${site.status === 'success' ? 'ÌôúÏÑ±' : 'Îπà Îç∞Ïù¥ÌÑ∞'}
                    </div>
                </div>
                
                <div class="site-stats">
                    <div class="stat-item">
                        <span class="stat-label">Ï¥ù Îç∞Ïù¥ÌÑ∞</span>
                        <span class="stat-value">${site.total_count.toLocaleString()}Í∞ú</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏</span>
                        <span class="stat-value">${this.formatDateTime(site.last_updated)}</span>
                    </div>
                </div>
                
                <div class="actions">
                    <button class="btn btn-primary crawl-btn" onclick="app.startCrawling('${site.site_key}')">
                        <span class="btn-text">ÌÅ¨Î°§ÎßÅ</span>
                        <span class="loading" style="display: none;"></span>
                    </button>
                    <a href="/sites/${site.site_key}" class="view-btn" title="ÏÉÅÏÑ∏Î≥¥Í∏∞">üìÑ</a>
                </div>
            </div>
        `).join('');
        
        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        this.updateStats(data.sites);
    }

    updateStats(sites) {
        const totalRecords = sites.reduce((sum, site) => sum + site.total_count, 0);
        const activeSites = sites.filter(site => site.status === 'success').length;
        
        const statsElement = document.querySelector('.stats-overview');
        if (statsElement) {
            statsElement.innerHTML = `
                <h3>Ï†ÑÏ≤¥ ÌòÑÌô©</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-number">${totalRecords.toLocaleString()}</span>
                        <span class="stat-description">Ï¥ù ÏàòÏßë Îç∞Ïù¥ÌÑ∞</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${activeSites}</span>
                        <span class="stat-description">ÌôúÏÑ± ÏÇ¨Ïù¥Ìä∏</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${sites.length}</span>
                        <span class="stat-description">Î™®ÎãàÌÑ∞ÎßÅ ÏÇ¨Ïù¥Ìä∏</span>
                    </div>
                </div>
            `;
        }
    }

    async loadSiteData() {
        const siteKey = this.getSiteKeyFromURL();
        if (!siteKey) return;
        
        try {
            console.log(`ÏÇ¨Ïù¥Ìä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎî©: ${siteKey}`);
            
            const urlParams = new URLSearchParams(window.location.search);
            const page = urlParams.get('page') || 1;
            const search = urlParams.get('search') || '';
            
            const response = await fetch(`/api/sites/${siteKey}/data?page=${page}&search=${encodeURIComponent(search)}`);
            if (!response.ok) throw new Error('ÏÇ¨Ïù¥Ìä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®');
            
            const data = await response.json();
            this.renderSiteData(data);
            
            console.log('ÏÇ¨Ïù¥Ìä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å:', data);
            
        } catch (error) {
            console.error('ÏÇ¨Ïù¥Ìä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
            this.showNotification('ÏÇ¨Ïù¥Ìä∏ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®', 'error');
        }
    }

    renderSiteData(data) {
        const container = document.getElementById('siteData');
        if (!container) return;
        
        // ÌÖåÏù¥Î∏î Ìó§Îçî ÏÉùÏÑ±
        const columns = data.data.length > 0 ? Object.keys(data.data[0]) : [];
        
        container.innerHTML = `
            <div class="data-table">
                <div class="table-header">
                    <h3>${data.site_name} Îç∞Ïù¥ÌÑ∞ (Ï¥ù ${data.pagination.total_count.toLocaleString()}Í∞ú)</h3>
                    <div class="table-controls">
                        <input type="text" class="search-input" placeholder="Í≤ÄÏÉâ..." 
                               value="${data.search}" onkeypress="app.handleSearchKeypress(event)">
                        <button class="btn btn-secondary btn-sm" onclick="app.exportData('${data.site_key}')">
                            üì§ Excel ÎÇ¥Î≥¥ÎÇ¥Í∏∞
                        </button>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            ${columns.map(col => `<th>${col}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${data.data.map(row => `
                            <tr>
                                ${columns.map(col => `<td>${this.escapeHtml(row[col] || '')}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
                
                ${this.renderPagination(data.pagination)}
            </div>
        `;
    }

    renderPagination(pagination) {
        if (pagination.total_pages <= 1) return '';
        
        const currentPage = pagination.page;
        const totalPages = pagination.total_pages;
        
        let pages = [];
        
        // Ïù¥Ï†Ñ Î≤ÑÌäº
        if (pagination.has_prev) {
            pages.push(`<a href="?page=${currentPage - 1}" class="page-btn">‚Äπ Ïù¥Ï†Ñ</a>`);
        }
        
        // ÌéòÏù¥ÏßÄ Î≤àÌò∏Îì§
        for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
            const active = i === currentPage ? 'active' : '';
            pages.push(`<a href="?page=${i}" class="page-btn ${active}">${i}</a>`);
        }
        
        // Îã§Ïùå Î≤ÑÌäº
        if (pagination.has_next) {
            pages.push(`<a href="?page=${currentPage + 1}" class="page-btn">Îã§Ïùå ‚Ä∫</a>`);
        }
        
        return `
            <div class="pagination">
                ${pages.join('')}
            </div>
        `;
    }

    async startCrawling(siteKey) {
        try {
            console.log(`ÌÅ¨Î°§ÎßÅ ÏãúÏûë: ${siteKey}`);
            
            // Î≤ÑÌäº ÏÉÅÌÉú Î≥ÄÍ≤Ω (ÏïàÏ†ÑÌïú Î∞©Î≤ï)
            const buttons = document.querySelectorAll(`.crawl-btn`);
            let targetButton = null;
            
            // ÌòÑÏû¨ ÌÅ¥Î¶≠Îêú Î≤ÑÌäº Ï∞æÍ∏∞
            buttons.forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                if (onclick && onclick.includes(siteKey)) {
                    targetButton = btn;
                }
            });
            
            if (targetButton) {
                const btnText = targetButton.querySelector('.btn-text');
                const loading = targetButton.querySelector('.loading');
                
                if (btnText) btnText.textContent = 'ÏßÑÌñâ Ï§ë...';
                if (loading) loading.style.display = 'inline-block';
                targetButton.disabled = true;
            }
            
            const response = await fetch(`/api/crawl/${siteKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) throw new Error('ÌÅ¨Î°§ÎßÅ ÏãúÏûë Ïã§Ìå®');
            
            const result = await response.json();
            this.showNotification(result.message, 'success');
            
        } catch (error) {
            console.error('ÌÅ¨Î°§ÎßÅ ÏãúÏûë Ïò§Î•ò:', error);
            this.showNotification('ÌÅ¨Î°§ÎßÅ ÏãúÏûë Ïã§Ìå®', 'error');
            
            // Î≤ÑÌäº ÏÉÅÌÉú Î≥µÏõê (ÏïàÏ†ÑÌïú Î∞©Î≤ï)
            const buttons = document.querySelectorAll(`.crawl-btn`);
            buttons.forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                if (onclick && onclick.includes(siteKey)) {
                    const btnText = btn.querySelector('.btn-text');
                    const loading = btn.querySelector('.loading');
                    
                    if (btnText) btnText.textContent = 'ÌÅ¨Î°§ÎßÅ';
                    if (loading) loading.style.display = 'none';
                    btn.disabled = false;
                }
            });
        }
    }

    async startAllCrawling() {
        try {
            console.log('Ï†ÑÏ≤¥ ÌÅ¨Î°§ÎßÅ ÏãúÏûë');
            
            const response = await fetch('/api/crawl/all', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) throw new Error('Ï†ÑÏ≤¥ ÌÅ¨Î°§ÎßÅ ÏãúÏûë Ïã§Ìå®');
            
            const result = await response.json();
            this.showNotification(result.message, 'success');
            
        } catch (error) {
            console.error('Ï†ÑÏ≤¥ ÌÅ¨Î°§ÎßÅ ÏãúÏûë Ïò§Î•ò:', error);
            this.showNotification('Ï†ÑÏ≤¥ ÌÅ¨Î°§ÎßÅ ÏãúÏûë Ïã§Ìå®', 'error');
        }
    }

    handleSearchKeypress(event) {
        if (event.key === 'Enter') {
            const searchValue = event.target.value;
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('search', searchValue);
            currentUrl.searchParams.set('page', '1'); // Í≤ÄÏÉâ Ïãú Ï≤´ ÌéòÏù¥ÏßÄÎ°ú
            window.location.href = currentUrl.toString();
        }
    }

    exportData(siteKey) {
        // ÌòÑÏû¨Îäî Í∞ÑÎã®Ìïú ÏïåÎ¶ºÎßå ÌëúÏãú
        this.showNotification('Excel ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Í∏∞Îä•ÏùÄ Ìñ•ÌõÑ Íµ¨ÌòÑ ÏòàÏ†ïÏûÖÎãàÎã§.', 'info');
    }

    setupEventListeners() {
        // Ï†ÑÏ≤¥ ÌÅ¨Î°§ÎßÅ Î≤ÑÌäº
        const allCrawlBtn = document.getElementById('allCrawlBtn');
        if (allCrawlBtn) {
            allCrawlBtn.addEventListener('click', () => this.startAllCrawling());
        }
        
        // ÏÉàÎ°úÍ≥†Ïπ® Î≤ÑÌäº
        const refreshBtn = document.getElementById('refreshBtn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => this.loadDashboardData());
        }
    }

    updateCrawlStatus(status) {
        // ÌÅ¨Î°§ÎßÅ ÏÉÅÌÉúÎ•º ÌôîÎ©¥Ïóê ÌëúÏãú
        const statusElement = document.getElementById('crawlStatus');
        if (statusElement) {
            statusElement.textContent = status;
        }
        
        // Î™®Îì† ÌÅ¨Î°§ÎßÅ Î≤ÑÌäºÏùò ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        document.querySelectorAll('.crawl-btn').forEach(btn => {
            if (status === 'ÏôÑÎ£å' || status === 'Ïò§Î•ò Î∞úÏÉù') {
                const btnText = btn.querySelector('.btn-text');
                const loading = btn.querySelector('.loading');
                
                btnText.textContent = 'ÌÅ¨Î°§ÎßÅ';
                loading.style.display = 'none';
                btn.disabled = false;
            }
        });
    }

    showNotification(message, type = 'info') {
        // Í∏∞Ï°¥ ÏïåÎ¶º Ï†úÍ±∞
        const existing = document.querySelector('.notification');
        if (existing) existing.remove();
        
        // ÏÉà ÏïåÎ¶º ÏÉùÏÑ±
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" 
                        style="background: none; border: none; font-size: 1.2rem; cursor: pointer;">√ó</button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Ïï†ÎãàÎ©îÏù¥ÏÖòÏúºÎ°ú ÌëúÏãú
        setTimeout(() => notification.classList.add('show'), 100);
        
        // 5Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 5000);
    }

    formatDateTime(dateString) {
        if (!dateString) return 'Ï†ïÎ≥¥ ÏóÜÏùå';
        
        try {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            // 1Î∂Ñ ÎØ∏Îßå
            if (diff < 60000) {
                return 'Î∞©Í∏à Ï†Ñ';
            }
            // 1ÏãúÍ∞Ñ ÎØ∏Îßå
            else if (diff < 3600000) {
                const minutes = Math.floor(diff / 60000);
                return `${minutes}Î∂Ñ Ï†Ñ`;
            }
            // 24ÏãúÍ∞Ñ ÎØ∏Îßå
            else if (diff < 86400000) {
                const hours = Math.floor(diff / 3600000);
                return `${hours}ÏãúÍ∞Ñ Ï†Ñ`;
            }
            // Í∑∏ Ïô∏
            else {
                return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
        } catch (error) {
            return dateString;
        }
    }

    getSiteKeyFromURL() {
        const pathParts = window.location.pathname.split('/');
        if (pathParts[1] === 'sites') {
            return pathParts[2];
        }
        return null;
    }

    escapeHtml(text) {
        if (typeof text !== 'string') text = String(text);
        
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
}

// Ïï± Ï¥àÍ∏∞Ìôî
let app;
document.addEventListener('DOMContentLoaded', () => {
    app = new TaxCrawlerApp();
});

// Ï†ÑÏó≠ Ìï®ÏàòÎì§ (HTMLÏóêÏÑú ÏßÅÏ†ë Ìò∏Ï∂úÏö©)
window.startCrawling = (siteKey) => app.startCrawling(siteKey);
window.startAllCrawling = () => app.startAllCrawling();
window.handleSearchKeypress = (event) => app.handleSearchKeypress(event);
window.exportData = (siteKey) => app.exportData(siteKey);